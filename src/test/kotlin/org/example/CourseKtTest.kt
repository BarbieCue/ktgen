package org.example

import io.kotest.assertions.throwables.shouldNotThrow
import io.kotest.inspectors.forAll
import io.kotest.matchers.collections.shouldHaveAtLeastSize
import io.kotest.matchers.collections.shouldHaveSize
import io.kotest.matchers.ints.shouldBeGreaterThanOrEqual
import io.kotest.matchers.shouldBe
import io.kotest.matchers.string.shouldHaveLength
import io.kotest.matchers.string.shouldHaveMaxLength
import io.kotest.matchers.string.shouldHaveMinLength
import java.io.File
import java.nio.file.attribute.PosixFilePermissions
import java.util.*
import kotlin.io.path.absolutePathString
import kotlin.io.path.createTempDirectory
import kotlin.io.path.exists

class CourseKtTest : IOExpectSpec({

    context("writeCourseFile") {

        expect("file exists after successful write") {
            val file = tmpFile("my_test_course${UUID.randomUUID()}.xml")
            writeCourseFile(file.absolutePathString(), Course())
            file.exists() shouldBe true
        }

        expect("file does not exist when writing failed") {
            val readOnly = PosixFilePermissions.fromString("r--r--r--")
            val fileAttributes = PosixFilePermissions.asFileAttribute(readOnly)
            val roDir = createTempDirectory("my-ro-dir", fileAttributes)
            val path = "$roDir/my_test_course${UUID.randomUUID()}.xml"
            writeCourseFile(path, Course())
            File(path).exists() shouldBe false
        }

        expect("nothing happens when path is empty") {
            shouldNotThrow<Exception> { writeCourseFile("", Course()) }
        }

        expect("nothing happens when path is invalid") {
            shouldNotThrow<Exception> { writeCourseFile("{/}....{}*", Course()) }
        }
    }

    context("writeCourse") {

        expect("file exists after successful write") {
            val dir = createTempDirectory("my-dir")
            val path = "$dir/my_test_course${UUID.randomUUID()}.xml"
            writeCourse(Course(), listOf(path))
            File(path).exists() shouldBe true
        }

        expect("file does not exist when writing failed") {
            val readOnly = PosixFilePermissions.fromString("r--r--r--")
            val fileAttributes = PosixFilePermissions.asFileAttribute(readOnly)
            val roDir = createTempDirectory("my-ro-dir", fileAttributes)
            val path = "$roDir/my_test_course${UUID.randomUUID()}.xml"
            writeCourse(Course(), listOf(path))
            File(path).exists() shouldBe false
        }

        expect("nothing happens when path is empty") {
            shouldNotThrow<Exception> { writeCourse(Course(), listOf("")) }
        }

        expect("nothing happens when path is invalid") {
            shouldNotThrow<Exception> { writeCourse(Course(), listOf("{/}....{}*")) }
        }
    }

    context("Course") {

        context("toXml") {

            expect("creates an xml representation of the course as string") {
                Course(id = "196dc484-8148-4c6d-9700-e34d06f06a40",
                    lessons = listOf(Lesson(
                        id = "342e8f50-d967-4f92-ab37-ea6ecd6c58cd",
                        title = "abc",
                        newCharacters = "cg",
                        text = "..."))).toXml() shouldBe """
            <?xml version="1.0" encoding="UTF-8"?><course>
              <id>196dc484-8148-4c6d-9700-e34d06f06a40</id>
              <title>Generated by ktgen</title>
              <description>Visit ktgen on Github (https://github.com/BarbieCue/ktgen)</description>
              <keyboardLayout/>
              <lessons>
                <lesson>
                  <id>342e8f50-d967-4f92-ab37-ea6ecd6c58cd</id>
                  <title>abc</title>
                  <newCharacters>cg</newCharacters>
                  <text>...</text>
                </lesson>
              </lessons>
            </course>
        """.trimIndent()
            }
        }
    }

    context("createCourse") {

        expect("have meta information set") {
            val course = createCourse(emptyList(), emptyList(), 0, 0)
            course.keyboardLayout shouldBe ""
            shouldNotThrow<Exception> { UUID.fromString(course.id) }
            course.title shouldBe "Generated by ktgen"
            course.description shouldBe "Visit ktgen on Github (https://github.com/BarbieCue/ktgen)"
        }

        expect("course consists of lessons containing the specified symbols") {
            val lessonSpecification = listOf("ab", "cd")
            val course = createCourse(lessonSpecification, emptyList(), 20, 100)
            course.lessons.joinToString("") { it.newCharacters } shouldBe "abcd"
        }

        expect("course has no lessons when there are no specified symbols") {
            val lessonSpecification = emptyList<String>()
            val course = createCourse(lessonSpecification, emptyList(), 20, 100)
            course.lessons shouldBe emptyList()
        }

        expect("each lesson text contains exactly the specified amount of non-whitespace symbols (symbols-per-lesson)") {
            val lessonSpecification = listOf("ab", "cd")
            val symbolsPerLesson = 100
            val course = createCourse(lessonSpecification, emptyList(), 20, symbolsPerLesson)
            course.lessons shouldHaveAtLeastSize 2
            course.lessons.forAll { it.text.symbolsCount() shouldBe 100 }
        }

        expect("each line of each lesson's text has a length of line-length or line-length-1, except the last line can be shorter") {
            val lessonSpecification = listOf("ab", "cd")
            val lineLength = 20
            val course = createCourse(lessonSpecification, emptyList(), lineLength, 100)
            course.lessons shouldHaveAtLeastSize 2
            course.lessons.forAll { lesson ->
                val lines = lesson.text.split('\n')
                lines shouldHaveAtLeastSize 2
                lines.dropLast(1).forAll { line ->
                    line shouldHaveMinLength 19
                    line shouldHaveMaxLength 20
                }
            }
        }

        expect("course contains word lessons when a non-empty dictionary is passed") {
            val lessonSpecification = listOf("ab", "cd", "ef", "gh")
            val dictionary = listOf("gag")
            val course = createCourse(lessonSpecification, dictionary, 20, 100)
            course.lessons shouldHaveAtLeastSize 1
            course.lessons.count { it.text.contains("gag") } shouldBeGreaterThanOrEqual 1
        }

        expect("line-length range test") {
            val lessonSpecification = listOf("ab")
            val symbolsPerLesson = 200
            createCourse(lessonSpecification, emptyList(), -100, symbolsPerLesson).lessons shouldHaveSize 0
            createCourse(lessonSpecification, emptyList(), -1, symbolsPerLesson).lessons shouldHaveSize 0
            createCourse(lessonSpecification, emptyList(), 0, symbolsPerLesson).lessons shouldHaveSize 0

            createCourse(lessonSpecification, emptyList(), 1, symbolsPerLesson).lessons.size shouldBeGreaterThanOrEqual 1
            createCourse(lessonSpecification, emptyList(), 1, symbolsPerLesson).lessons.forAll {
                it.text.split('\n') shouldHaveSize 200
                it.text.split('\n').forAll { line -> line shouldHaveLength 1 }
            }

            createCourse(lessonSpecification, emptyList(), 100, symbolsPerLesson).lessons.size shouldBeGreaterThanOrEqual 1
            createCourse(lessonSpecification, emptyList(), 100, symbolsPerLesson).lessons.forAll {
                it.text.split('\n') shouldHaveAtLeastSize 1
                it.text.split('\n').dropLast(1) // last line can be shorter
                    .forAll { line ->
                        line shouldHaveMinLength 99
                        line shouldHaveMaxLength 100 } }
        }

        expect("symbols-per-lesson range test") {
            val lessonSpecification = listOf("ab")
            val lineLength = 100
            createCourse(lessonSpecification, emptyList(), lineLength, -100).lessons shouldHaveSize 0
            createCourse(lessonSpecification, emptyList(), lineLength, -1).lessons shouldHaveSize 0
            createCourse(lessonSpecification, emptyList(), lineLength, 0).lessons shouldHaveSize 0

            createCourse(lessonSpecification, emptyList(), lineLength, 1).lessons.size shouldBeGreaterThanOrEqual 1
            createCourse(lessonSpecification, emptyList(), lineLength, 1).lessons.forAll { it.text.count { char -> !char.isWhitespace() } shouldBe  1 }

            createCourse(lessonSpecification, emptyList(), lineLength, 100).lessons.size shouldBeGreaterThanOrEqual 1
            createCourse(lessonSpecification, emptyList(), lineLength, 100).lessons.forAll { it.text.count { char -> !char.isWhitespace() } shouldBe  100 }
        }
    }
})